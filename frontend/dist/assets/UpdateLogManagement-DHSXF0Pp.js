import{b as M,A as _,a as V}from"./index-Byhz0bWx.js";import{d as m,f as h,j as L,p as j,q as U,m as q,t as C,B as x,g as R,o as H,n as J,r as K}from"./naive-ui-DOxxWvKY.js";import{k as O,r as u,c as Q,o as W,H as c,I as i,W as t,O as l,P as n,K as P,j as d,N,J as I,F as $,Q as G,M as g}from"./vue-vendor-CMZ7xYHN.js";const X={class:"card-header"},Y={class:"log-header"},Z={class:"log-date"},ee={key:1,class:"log-author"},ae={class:"log-content"},te=O({__name:"UpdateLogManagement",setup(ne){const{showAlert:f}=M(),o=u([]),v=u(!1),k=u(!1),w=u(null),b=u(null),p=u(null),r=u({content:"",isPinned:!1}),A=Q(()=>[...o.value].sort((a,e)=>a.is_pinned&&!e.is_pinned?-1:!a.is_pinned&&e.is_pinned?1:new Date(e.created_at).getTime()-new Date(a.created_at).getTime())),z=async()=>{v.value=!0,p.value=null;try{o.value=await _.listUpdateLogs()}catch(a){p.value=a instanceof Error?a.message:"获取更新日志失败"}finally{v.value=!1}},B=()=>{r.value.content="",r.value.isPinned=!1},E=async()=>{if(r.value.content.trim()){k.value=!0;try{const a=await _.createUpdateLog({content:r.value.content.trim(),is_pinned:r.value.isPinned});o.value.unshift(a),B(),f("更新日志发布成功","success")}catch(a){f(a instanceof Error?a.message:"发布失败","error")}finally{k.value=!1}}},D=async a=>{w.value=a;try{await _.deleteUpdateLog(a),o.value=o.value.filter(e=>e.id!==a),f("删除成功","success")}catch(e){f(e instanceof Error?e.message:"删除失败","error")}finally{w.value=null}},F=async(a,e)=>{b.value=a.id;try{const s=await _.updateUpdateLog(a.id,{is_pinned:e}),y=o.value.findIndex(T=>T.id===a.id);y!==-1&&o.value.splice(y,1,s)}catch(s){f(s instanceof Error?s.message:"更新失败","error")}finally{b.value=null}},S=a=>{const e=new Date(a);return Number.isNaN(e.getTime())?a:e.toLocaleString()};return W(z),(a,e)=>(i(),c(n(L),{bordered:!1,class:"admin-card"},{header:t(()=>[g("div",X,[e[4]||(e[4]=g("span",{class:"card-title"},"更新日志管理",-1)),l(n(x),{quaternary:"",size:"small",onClick:z,loading:v.value},{default:t(()=>[...e[3]||(e[3]=[d(" 刷新 ",-1)])]),_:1},8,["loading"])])]),default:t(()=>[l(n(m),{vertical:"",size:"large"},{default:t(()=>[p.value?(i(),c(n(h),{key:0,type:"error",closable:"",onClose:e[0]||(e[0]=s=>p.value=null)},{default:t(()=>[d(N(p.value),1)]),_:1})):P("",!0),l(n(L),{size:"small",class:"form-card"},{default:t(()=>[l(n(j),{model:r.value,"label-placement":"top"},{default:t(()=>[l(n(U),{label:"更新内容"},{default:t(()=>[l(n(q),{value:r.value.content,"onUpdate:value":e[1]||(e[1]=s=>r.value.content=s),type:"textarea",autosize:{minRows:3,maxRows:10},placeholder:"输入新的更新日志..."},null,8,["value"])]),_:1}),l(n(U),{label:"置顶"},{default:t(()=>[l(n(C),{value:r.value.isPinned,"onUpdate:value":e[2]||(e[2]=s=>r.value.isPinned=s)},null,8,["value"])]),_:1}),l(n(m),{justify:"end"},{default:t(()=>[l(n(x),{type:"primary",loading:k.value,onClick:E,disabled:!r.value.content.trim()},{default:t(()=>[...e[5]||(e[5]=[d(" 发布日志 ",-1)])]),_:1},8,["loading","disabled"])]),_:1})]),_:1},8,["model"])]),_:1}),l(n(R),{show:v.value},{default:t(()=>[!o.value.length&&!v.value?(i(),c(n(H),{key:0,description:"目前还没有更新记录"})):(i(),c(n(m),{key:1,vertical:"",size:"large"},{default:t(()=>[(i(!0),I($,null,G(A.value,s=>(i(),c(n(L),{key:s.id,bordered:!1,size:"small",class:"log-card"},{default:t(()=>[g("div",Y,[l(n(m),{align:"center",size:"small"},{default:t(()=>[s.is_pinned?(i(),c(n(J),{key:0,type:"warning",bordered:!1},{default:t(()=>[...e[6]||(e[6]=[d("置顶",-1)])]),_:1})):P("",!0),g("span",Z,N(S(s.created_at)),1),s.created_by?(i(),I("span",ee,"by "+N(s.created_by),1)):P("",!0)]),_:2},1024),l(n(m),{size:"small"},{default:t(()=>[l(n(C),{value:s.is_pinned,size:"small",loading:b.value===s.id,"onUpdate:value":y=>F(s,y)},{checked:t(()=>[...e[7]||(e[7]=[d("置顶",-1)])]),unchecked:t(()=>[...e[8]||(e[8]=[d("置顶",-1)])]),_:1},8,["value","loading","onUpdate:value"]),l(n(K),{placement:"left","positive-text":"删除","negative-text":"取消",type:"error",onPositiveClick:()=>D(s.id)},{trigger:t(()=>[l(n(x),{quaternary:"",type:"error",size:"small",loading:w.value===s.id},{default:t(()=>[...e[9]||(e[9]=[d(" 删除 ",-1)])]),_:1},8,["loading"])]),default:t(()=>[e[10]||(e[10]=d(" 确认删除该更新日志？ ",-1))]),_:2},1032,["onPositiveClick"])]),_:2},1024)]),g("div",ae,N(s.content),1)]),_:2},1024))),128))]),_:1}))]),_:1},8,["show"])]),_:1})]),_:1}))}}),oe=V(te,[["__scopeId","data-v-9906fcfb"]]);export{oe as default};
